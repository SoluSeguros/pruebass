<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Validador de Tiquetes</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

<style>
  body{
    margin:0;
    font-family: system-ui, Arial, sans-serif;
    background:#0b1220;
    color:#fff;
    text-align:center;
  }
  h2{
    margin:12px 0;
  }
  #reader{
    width:100%;
    max-width:420px;
    margin:0 auto;
  }
  .status{
    padding:18px;
    font-size:1.4rem;
    font-weight:bold;
  }
  .idle{ background:#111827; }
  .ok{ background:#0a7a32; }
  .bad{ background:#8a1c1c; }
</style>
</head>
<body>

<h2>üé´ Validador de Tiquetes</h2>

<div id="reader"></div>

<div id="status" class="status idle">
  Apunte el QR al lector
</div>

<!-- LIBRER√çA ESTABLE PARA QR -->
<script src="https://unpkg.com/html5-qrcode@2.3.9/html5-qrcode.min.js"></script>

<script>
const statusBox = document.getElementById("status");

// Control anti-duplicado
const qrLeidos = new Set();
const lastRead = new Map();
const COOLDOWN = 5000; // ms

// üîä Beep
function beep(ok=true){
  const ctx = new (window.AudioContext || window.webkitAudioContext)();
  const osc = ctx.createOscillator();
  osc.type = "sine";
  osc.frequency.value = ok ? 1200 : 400;
  osc.connect(ctx.destination);
  osc.start();
  setTimeout(() => osc.stop(), ok ? 150 : 400);
}

// ‚úÖ QR le√≠do correctamente
function onScanSuccess(decodedText){
  const now = Date.now();

  if (lastRead.has(decodedText) && now - lastRead.get(decodedText) < COOLDOWN){
    statusBox.textContent = "‚ùå TIQUETE YA REGISTRADO";
    statusBox.className = "status bad";
    beep(false);
    return;
  }

  lastRead.set(decodedText, now);
  qrLeidos.add(decodedText);

  statusBox.textContent = "‚úÖ TIQUETE VALIDADO";
  statusBox.className = "status ok";
  beep(true);

  console.log("QR:", decodedText);

  // üîó Aqu√≠ puedes enviar a backend con fetch()
  // fetch("http://localhost:5000/qr", { method:"POST", body: decodedText })
}

// ‚ùå Fallos de lectura (se ignoran)
function onScanFailure(error){
  // No mostrar nada, es normal
}

// üöÄ Iniciar lector
const html5QrCode = new Html5Qrcode("reader");

html5QrCode.start(
  { facingMode: "environment" }, // c√°mara trasera
  {
    fps: 10,
    qrbox: { width: 250, height: 250 },
    disableFlip: true
  },
  onScanSuccess,
  onScanFailure
).catch(err => {
  statusBox.textContent = "‚ùå No se pudo acceder a la c√°mara";
  statusBox.className = "status bad";
  console.error(err);
});
</script>

</body>
</html>
