<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Validador de Tiquetes</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
  body{
    margin:0;
    font-family:system-ui,Arial;
    background:#0b1220;
    color:#fff;
    text-align:center;
  }
  header{
    padding:14px;
    background:#020617;
    font-size:1.3rem;
    font-weight:600;
  }
  #reader{
    width:100%;
    max-width:420px;
    margin:20px auto;
    display:none;
  }
  .status{
    padding:16px;
    font-size:1.3rem;
    font-weight:bold;
    margin-top:10px;
  }
  .idle{ background:#111827; }
  .ok{ background:#0a7a32; }
  .bad{ background:#8a1c1c; }

  button{
    background:#1663ff;
    color:#fff;
    border:none;
    padding:14px 22px;
    font-size:1.1rem;
    border-radius:10px;
    cursor:pointer;
    margin-top:20px;
  }
</style>
</head>
<body>

<header>üé´ Validador de Tiquetes</header>

<button id="startBtn">üì∑ Iniciar c√°mara</button>

<div id="reader"></div>

<div id="status" class="status idle">
  Apunte el QR al lector
</div>

<script src="https://unpkg.com/html5-qrcode@2.3.9/html5-qrcode.min.js"></script>

<script>
const statusBox = document.getElementById("status");
const startBtn = document.getElementById("startBtn");
const reader = document.getElementById("reader");

const qrLeidos = new Set();
const lastRead = new Map();
const COOLDOWN = 5000;

function beep(ok=true){
  const ctx = new (window.AudioContext || window.webkitAudioContext)();
  const osc = ctx.createOscillator();
  osc.frequency.value = ok ? 1200 : 400;
  osc.connect(ctx.destination);
  osc.start();
  setTimeout(()=>osc.stop(), ok ? 150 : 400);
}

function onScanSuccess(decodedText){
  const now = Date.now();

  if (lastRead.has(decodedText) && now - lastRead.get(decodedText) < COOLDOWN){
    statusBox.textContent = "‚ùå TIQUETE YA REGISTRADO";
    statusBox.className = "status bad";
    beep(false);
    return;
  }

  lastRead.set(decodedText, now);
  qrLeidos.add(decodedText);

  statusBox.textContent = "‚úÖ TIQUETE VALIDADO";
  statusBox.className = "status ok";
  beep(true);

  console.log("QR:", decodedText);
}

function onScanFailure(error){
  // ignorar
}

const html5QrCode = new Html5Qrcode("reader");

startBtn.addEventListener("click", () => {
  startBtn.style.display = "none";
  reader.style.display = "block";

  html5QrCode.start(
    { facingMode: "environment" },
    {
      fps: 10,
      qrbox: { width: 250, height: 250 }
    },
    onScanSuccess,
    onScanFailure
  ).catch(err=>{
    statusBox.textContent = "‚ùå No se pudo acceder a la c√°mara";
    statusBox.className = "status bad";
    console.error(err);
  });
});
</script>

</body>
</html>


